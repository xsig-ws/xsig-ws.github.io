<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
</head>

<pre>
産総研クラスタ(F32, SAKURA)利用ガイド (2006年1月27日版)

１．はじめに
産総研はグリッドチャレンジ2006に F32 クラスタ(の一部)と SAKURA クラス
タの2台を提供する．これらのクラスタはグリッドチャレンジに占有提供され
ているものではなくその他一般のユーザと共有されるものであるため，ここに
記載する利用の手引きに従った利用をお願いしたい．一部の制限についてはシ
ステム的に制限をかけているものではなく，紳士協定として利用者に守って頂
いているものもある．利用の手引きは安定した性能の享受，利便性，システム
利用率の向上などを考慮して決定したものであり，グリッドチャレンジ参加者
の方々にもご理解およびご協力をお願いしたい．
ただし，本選期間中はグリッドチャレンジ2006参加者に占有提供されるため，
4節に記載される利用に際しての制限は適用されない．

２．クラスタ情報
産総研はグリッドチャレンジ2006に F32 クラスタ(の一部)と SAKURA クラス
タの2台を提供する．

(1) F32 クラスタ (129ノード/258CPU)
ハードウェア
  CPU:      dual Intel Xeon 3.0GHz
  Memory:   ログインノード： 4GB / 1node
	    計算ノード：     4GB / 1node
  Network:  Gigabit Ethernet

ソフトウェア
  OS:       Linux RedHat 8.0
  Compiler: gcc 3.3.3
	    PGI High-Performance Compilers Ver. 5.2
	    Intel C++/Fortran Compiler Ver. 8.0 (非商用版のためユーザ
	    がライセンスを取得する必要がある．詳細は Intel の Web サイ
	    トを参照のこと)
  Batch system:  Sun Grid Engine 6.0

ホスト情報：
  ログインノード： fsvc003.asc.hpcc.jp (163.220.53.10)
  計算ノード：     総数 128ノード / 256CPU
		   ノードに障害が発生したときには随時スペアノードを補
		   充するため，ホストは不定である(固定されていない)．
		   登録されている計算ノードは，以下のように qconf コマ
		   ンドを実行することにより確認することができる．

		   % conf -shgrp @FP3

  ファイルシステム: ログインノードと計算ノードのホームディレクトリは
		    NFS によって共有されている


(2) SAKURA クラスタ (17ノード/34CPU)
ハードウェア
  CPU:      ログインノード： dual AMD Opteron 2.2GHz
	    計算ノード：     dual AMD Opteron 1.8GHz
  Memory:   ログインノード： 2GB / 1node
	    計算ノード：     3GB / 1node
  Network:  Gigabit Ethernet

ソフトウェア
  OS:	    SUSE Linux Enterprise Server 8
  Compiler: GCC 3.2.2
  Batch system:  Sun Grid Engine 6.0

ホスト情報：
  ログインノード： sakura.hpcc.jp (163.220.27.104)
  計算ノード：	   総数 16ノード / 32CPU
		   sakura00.hpcc.jp
		   sakura01.hpcc.jp
		   ...
		   sakura0f.hpcc.jp
		   ノードに障害が発生したときにはそのノードは利用不可
		   能となり，利用可能な計算ノードも減ることになる．
  ファイルシステム: ログインノードと計算ノードのホームディレクトリは
		    NFS によって共有されている

３．グリッドミドルウェア
F32 と SAKURA クラスタのいずれにも以下のグリッドミドルウェアがインストー
ルされている．

- Globus Toolkit
  - F32: GT 3.2 PreWS Module (GT 4.0.1 PreWS に切り替え予定)
  - SAKURA: GT 2.4.3
- Ninf-G 2.4.0
- GridMPI

これらのミドルウェアの利用に際して必要な環境変数はログイン時に自動的に
設定される．
Globus および Ninf-G の利用方法の詳細については別の文書「グリッドチャ
レンジにおける Globus Toolkit，Ninf-G の使い方」を参照のこと．

４．利用方法・注意事項
F32 と SAKURA クラスタの利用に際し，利用方法および守って頂きたい注意事
項を列挙する．

(1) ssh でのログインを許可するのは原則としてログインノードのみである．
    計算ノードへのログインは基本的には禁止．ただし，システム的にはログ
    イン可能となっている．これは，計算ノードのローカルディスクに生成し
    たファイルを参照したい場合などのためにログインの制限をかけていない
    ものであり，グリッドチャレンジ参加者に対しても，そのような軽微な利
    用に限って計算ノードへのログインは許可する．
    ただし，計算ノードにログインして計算を行うプロセスを直接起動するこ
    とは禁止する．

(2) 計算ノード上で計算プロセスを起動する場合は，必ずバッチシステム(N1
    Grid Engine)を利用すること．バッチを利用せずに計算ノードに対して
    ssh を用いて計算プロセスを起動することは原則として禁止する．
    Grid Engineの利用方法については，適当に google すれば情報が得られ
    る他，qsub などのコマンドについてはオンラインマニュアルも提供され
    ている．

(3) F32, SAKURA とも，Grid Engine において MPI プログラム実行用の
    Parallel Environment が設定されており，qsub コマンド等で Parallel
    Environment を指定すれば MPI プログラムの起動(qsub コマンドがノー
    ドを確保し，それらのノードに基づいて作成した machinefile を使って
    mpirun コマンドを実行)が可能となる．Parallel Environment の名前は
    mpich である．

(4) ssh を用いて計算ノード上で計算プロセスを起動したい場合には，次の2
    つのうちのいずれかの方法を利用すること．
      [1] 事前に qsub 等でノードを確保してからやる
        例えば10分間 sleep するジョブを qsub コマンドを使って投入し，
        ジョブがディスパッチされた時点でジョブが起動された計算ノードの
        ホスト名を取得し，それらに対して ssh を使ってジョブを起動する
	詳細は「５．計算ノードへの ssh の利用について」を参照のこと．

      [2] qrsh という SGE が提供する ssh ライクなコマンドを利用する
        qrsh は Grid Engine が提供する ssh ライクなコマンドであり，ロ
        グインノード上で qrsh というコマンドを実行すると Grid Engine
        が適当な計算ノードを割り当て，そこでジョブを起動する，あるいは
        Grid Engine が選択した計算ノードにログインすることができる．
	詳細は「５．計算ノードへの ssh の利用について」を参照のこと．

   利用負荷が高く queue が詰まっている場合，(1) の方法だと queue が空
   くまで待たされることになり，(2) の方法だとエラーが返る．

(5) ログインノードでは重いジョブを長時間走らせるようなことはしないこと．
    プログラムのコンパイル程度であれば良い．

５．計算ノードへの ssh の利用について
F32/SAKURA クラスタは ssh を利用した計算ノード上でのプロセス起動を基本
的に禁止しているが，グリッドチャレンジ参加者に対してはバッチを介して計
算ノードを事前に確保することを条件に許可する．ここでは，いくつかある具
体的な方法のいくつかを紹介する．他にも方法は考えられるが，Grid Engine
のマニュアル等を参照して用途に適した方法を考えて頂きたい．

以下の例では，いずれもクライアントからサーバ(sakura.hpcc.jp)に対して4
ノードを確保する方法を示している．

----------------------------------------------------------------------
例1： リモート(クライアント)マシンからノードを確保するジョブを
      globus-job-submit コマンドを利用して投入し，クライアントマシンに
      Grid Engine が確保したホストの一覧ファイルをコピーする方法

(1) サーバ(sakura.hpcc.jp) に以下のスクリプトを用意する
  % cat /home/yoshio/hoge.sh
  #!/bin/sh
  if [ -e $TMPDIR/machines ]; then
    scp $TMPDIR/machines $1
  fi
  sleep 600
  
(2) クライアントマシン上で globus-job-run コマンドを実行する．
  % globus-job-run sakura.hpcc.jp -np 4 -env SGE_PE=mpich_2 \
    /home/yoshio/hoge.sh CLIENT_HOST_NAME:hoge

Grid Engine がジョブをディスパッチするとクライアント上に hoge というファ
イルが作成されるので，クライアント側ではこのファイルが生成されるのを待
ち(監視し)，生成された時点で hoge というファイルに記載されているノード
に対して ssh をかければ良い．
この方法では確保された4台のノード上すべてで hoge.sh が実行されるが，
$TMPDIR/machines ファイルがあるのはそのうちの1台だけであり，scp もその
1台でのみ実行される．
----------------------------------------------------------------------
例2： リモート(クライアント)マシンからノードを確保するジョブを ssh コ
      マンドを利用して投入し，クライアントマシンに Grid Engine が確保
      したホストの一覧ファイルをコピーする方法

(1) サーバ(sakura.hpcc.jp) に以下のスクリプトを用意する
  % cat submit.sh
  #!/bin/sh
  . /etc/profile.d/sge.sh
  qrsh -pe mpich $1 $2 $3

  % cat hoge.sh
  #!/bin/sh
  #$ -S /bin/sh
  if [ -e $TMPDIR/machines ]; then
    scp $TMPDIR/machines $1
  fi
  sleep 600

(2) クライアントマシン上で ssh コマンドを実行する．
  % ssh sakura.hpcc.jp /home/yoshio/submit.sh 4 /home/yoshio/hoge.sh \
    CLIENT_HOST_NAME:hoge

Grid Engine がジョブをディスパッチするとクライアント上に hoge というファ
イルが作成されるので，クライアント側ではこのファイルが生成されるのを待
ち(監視し)，生成された時点で hoge というファイルに記載されているノード
に対して ssh をかければ良い．
この方法では確保された最初のノードで一度 scp が実行されるだけである．
----------------------------------------------------------------------
例3： ssh でノードを確保した上でそのうちの1台にログインし，生成されて
      いる machinefile を目視で確認する方法

(1) クライアントマシン上で ssh コマンドを利用する．
  % ssh -t sakura.hpcc.jp qrsh -pe mpich 4

このコマンドを実行すると，Grid Engine が4台のノードを確保した上で，そ
のうちの1台にログインできる．ここで，/tmp/XXXXXX.Y.FP?.q/ というディレ
クトリの下にある machines というファイルを参照すれば，Grid Engine が確
保したノードを確認できる．ここでクライアントマシン上でこれらのノードに
対して ssh をかければ良い．
----------------------------------------------------------------------
例4： ssh でノードを確保した上で，その名前の一覧をクライアントの
      stdout 上に表示させる方法

(1) クライアントマシン上で ssh コマンドを利用する．
  % ssh -t fsvc001.asc.hpcc.jp qrsh -pe mpich 4 \
    'cat \$TMPDIR/machines\; sleep 600'

このコマンドを実行すると，Grid Engine が4台のノードを確保した上で，そ
のホスト名の一覧がクライアントの stdout 上に表示される．ここでクライア
ントマシン上でこれらのノードに対して ssh をかければ良い．
----------------------------------------------------------------------

上記の例のうち qrsh を利用しているものについては，空いているノードがな
い場合にはエラーが返る事に留意されたい．

</pre>
</body>
</html>
